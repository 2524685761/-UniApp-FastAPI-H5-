<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>项目架构与流程图 (完整版)</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 40px; background-color: #f9f9f9; }
        h1 { text-align: center; color: #333; margin-bottom: 40px; }
        .chart-section { background: white; margin-bottom: 60px; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        h2 { color: #2c3e50; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 20px; }
        .mermaid { text-align: center; }
        .tips { text-align: center; color: #666; margin-bottom: 30px; font-style: italic; }
    </style>
</head>
<body>

    <h1>项目图表生成页 (修复增强版)</h1>
    <p class="tips">提示：等待渲染完成后，使用截图工具截取下方图表即可直接插入论文。</p>

    <!-- 1. 系统架构图 -->
    <div class="chart-section">
        <h2>1. 系统架构图 (System Architecture)</h2>
        <div class="mermaid">
        %%{init: {'theme': 'base', 'themeVariables': { 'primaryColor': '#fff', 'edgeLabelBackground':'#fff', 'tertiaryColor': '#fff'}}}%%
        graph TB
            subgraph Client ["前端展示层 (Frontend)"]
                direction TB
                UniApp[("uni-app (Vue 2)<br>跨端框架")]
                Pages[("页面视图<br>(Pages)")]
                API_Utils[("统一请求封装<br>(utils/api.js)")]
                Recorder[("录音管理器<br>(Recorder)")]
                Player[("音频播放器<br>(Player)")]
                
                UniApp --> Pages
                Pages --> Recorder
                Pages --> Player
                Pages --> API_Utils
            end

            subgraph Service ["后端服务层 (Backend Service)"]
                direction TB
                FastAPI[("FastAPI<br>Web 框架")]
                Router[("路由分发<br>(Main Router)")]
                
                subgraph Logic ["核心业务逻辑 (Services)"]
                    S_Vocab[("课程/词库服务")]
                    S_Audio[("音频处理服务")]
                    S_AI[("AI 推理服务<br>(ASR/SER/TTS)")]
                end
                
                FastAPI --> Router
                Router --> Logic
            end

            subgraph Data ["数据与存储层 (Data Layer)"]
                direction TB
                SQLite[("SQLite 数据库<br>(sql_app.db)")]
                ORM[("SQLAlchemy<br>ORM")]
                FileSys[("文件存储<br>(Uploads/Cache)")]
                Models[("AI 模型仓库<br>(Model Cache)")]
            end

            %% 跨层调用关系
            API_Utils == "HTTP / REST API" ==> FastAPI
            Logic --> ORM
            ORM <--> SQLite
            Logic --> FileSys
            S_AI -.-> Models
        </div>
    </div>

    <!-- 2. 核心模块流程图 A -->
    <div class="chart-section">
        <h2>2. 核心流程 A：录音上传与评测闭环</h2>
        <div class="mermaid">
        sequenceDiagram
            autonumber
            participant User as 学习者
            participant FE as 前端 (uni-app)
            participant BE as 后端 (FastAPI)
            participant AI as AI 分析服务
            participant DB as 数据库

            User->>FE: 长按录音 -> 松开
            FE->>FE: 生成音频文件 (mp3/wav)
            FE->>BE: POST /api/analyze (上传录音)
            
            activate BE
            BE->>BE: 音频格式校验 & 转码
            BE->>AI: 调用 ASR (语音转文字)
            AI-->>BE: 返回识别文本
            
            BE->>AI: 调用 SER (情感识别)
            AI-->>BE: 返回情绪标签 (如:困惑)
            
            BE->>BE: 计算评分 & 生成建议
            BE->>DB: 写入学习记录
            BE-->>FE: 返回结果 JSON (分/建议/情绪)
            deactivate BE
            
            FE->>User: 展示评分与纠音建议
            
            opt 情绪反馈
                FE->>User: (检测到困惑) 自动提示"播放示范"
            end
        </div>
    </div>

    <!-- 3. 核心模块流程图 B -->
    <div class="chart-section">
        <h2>3. 核心流程 B：TTS 示范生成与缓存机制</h2>
        <div class="mermaid">
        flowchart LR
            Start((用户请求播放)) --> CheckCache{检查本地缓存?}
            
            CheckCache -- "命中 (Hit)" --> ReturnFile[直接返回音频文件]
            
            CheckCache -- "未命中 (Miss)" --> OnlineTTS{尝试在线 TTS?}
            
            OnlineTTS -- "成功" --> SaveCache[保存到 uploads/tts]
            OnlineTTS -- "失败/网络错误" --> LocalTTS[调用本地离线引擎]
            
            LocalTTS --> SaveCache
            SaveCache --> ReturnFile
            ReturnFile --> End((播放音频))

            style CheckCache fill:#f9f,stroke:#333
            style OnlineTTS fill:#bbf,stroke:#333
            style LocalTTS fill:#ddd,stroke:#333
        </div>
    </div>

    <!-- 4. 实施计划甘特图 -->
    <div class="chart-section">
        <h2>4. 项目实施计划进度 (Gantt Chart)</h2>
        <div class="mermaid">
        gantt
            title 毕业设计项目实施进度表
            dateFormat  YYYY-MM-DD
            axisFormat  %m-%d
            
            section 需求与设计
            文献调研与开题       :done,    des1, 2026-01-01, 7d
            需求分析与原型设计   :active,  des2, after des1, 10d
            系统架构与数据库设计 :         des3, after des2, 7d
            
            section 核心开发 (Sprint)
            环境搭建与基础框架   :         dev1, after des3, 5d
            Sprint1: 录音评测闭环 :         dev2, after dev1, 10d
            Sprint2: TTS与缓存   :         dev3, after dev2, 7d
            Sprint3: 情感识别集成 :         dev4, after dev3, 7d
            Sprint4: 记录与生词本 :         dev5, after dev4, 7d
            
            section 测试与验收
            集成测试与Bug修复    :         test1, after dev5, 10d
            用户验收测试 (UAT)   :         test2, after test1, 5d
            
            section 论文撰写
            初稿撰写            :         doc1, after test2, 14d
            定稿与答辩准备       :         doc2, after doc1, 10d
        </div>
    </div>

    <script>
        mermaid.initialize({ startOnLoad: true });
    </script>

</body>
</html>